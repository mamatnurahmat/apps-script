<!DOCTYPE html>
<html class="light" lang="id">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"
        name="viewport" />
    <meta name="theme-color" content="#137fec">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Mobile ATEM - Sistem Inventory</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;display=swap"
        rel="stylesheet" />
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
        rel="stylesheet" />
    <!-- SweetAlert2 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">

    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#137fec",
                        "background-light": "#f6f7f8",
                        "background-dark": "#101922",
                    },
                    fontFamily: {
                        "display": ["Inter", "sans-serif"]
                    },
                    borderRadius: { "DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem", "full": "9999px" },
                },
            },
        }
    </script>
    <style>
        * {
            -webkit-tap-highlight-color: transparent;
        }

        html,
        body {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            position: fixed;
            -webkit-overflow-scrolling: touch;
        }

        body {
            overscroll-behavior: none;
        }

        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Main scrollable container */
        .main-scroll-container {
            height: 100vh;
            height: 100dvh;
            /* Dynamic viewport height for mobile */
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
        }

        /* Safe area for notched devices */
        .safe-area-top {
            padding-top: env(safe-area-inset-top);
        }

        .safe-area-bottom {
            padding-bottom: env(safe-area-inset-bottom);
        }

        /* Bottom nav safe area */
        .bottom-nav-safe {
            padding-bottom: calc(env(safe-area-inset-bottom) + 0.5rem);
        }

        /* Content padding to account for fixed bottom nav */
        .content-bottom-padding {
            padding-bottom: 1.5rem;
        }

        /* Smooth scroll */
        .smooth-scroll {
            scroll-behavior: smooth;
        }

        /* Pull to refresh styling */
        @supports (-webkit-overflow-scrolling: touch) {
            .main-scroll-container {
                -webkit-overflow-scrolling: touch;
            }
        }
    </style>
</head>

<body class="bg-background-light dark:bg-background-dark font-display text-slate-900 dark:text-slate-100">

    <!-- Login Modal (Full Screen Overlay) - HIDDEN -->
    <div id="loginOverlay"
        class="fixed inset-0 z-[100] bg-white dark:bg-slate-900 flex-col items-center justify-center p-4 transition-all duration-500 hidden opacity-0 pointer-events-none">
        <div
            class="w-full max-w-sm bg-white dark:bg-slate-800 rounded-2xl shadow-xl border border-slate-100 dark:border-slate-700 p-8 transform transition-all hover:scale-[1.01] duration-300">
            <div class="flex flex-col items-center mb-6">
                <div class="bg-primary/10 text-primary p-3 rounded-full mb-4">
                    <span class="material-symbols-outlined text-3xl">medical_services</span>
                </div>
                <h2 class="text-2xl font-bold text-slate-900 dark:text-white">ATEM Login</h2>
                <p class="text-sm text-slate-500 dark:text-slate-400 mt-1">Masuk untuk mengakses sistem</p>
            </div>

            <form onsubmit="handleLogin(event)" class="flex flex-col gap-4">
                <div>
                    <label class="block text-xs font-semibold text-slate-500 uppercase tracking-wider mb-1.5"
                        for="username">Username</label>
                    <div class="relative">
                        <span
                            class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-[20px]">person</span>
                        <input id="username" type="text" required
                            class="pl-10 block w-full rounded-lg border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-900/50 text-sm focus:border-primary focus:ring-primary dark:text-white dark:placeholder-slate-500"
                            placeholder="Masukkan username">
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-semibold text-slate-500 uppercase tracking-wider mb-1.5"
                        for="password">Password</label>
                    <div class="relative">
                        <span
                            class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-[20px]">lock</span>
                        <input id="password" type="password" required
                            class="pl-10 block w-full rounded-lg border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-900/50 text-sm focus:border-primary focus:ring-primary dark:text-white dark:placeholder-slate-500"
                            placeholder="••••••••">
                    </div>
                </div>

                <button type="submit"
                    class="mt-2 w-full bg-primary hover:bg-blue-600 active:scale-95 text-white font-bold py-2.5 rounded-lg shadow-lg shadow-blue-500/30 transition-all flex items-center justify-center gap-2">
                    <span>Masuk</span>
                    <span class="material-symbols-outlined text-[18px]">arrow_forward</span>
                </button>
            </form>

            <div class="mt-6 text-center text-xs text-slate-400">
                &copy; Simantools Inventory System
            </div>
        </div>
    </div>

    <!-- Main Container - Full Screen -->
    <div class="main-scroll-container smooth-scroll bg-white dark:bg-slate-900">

        <!-- Content Wrapper with bottom padding for fixed nav -->
        <div class="content-bottom-padding">

            <!-- Header - Sticky -->
            <header
                class="sticky top-0 z-40 flex items-center justify-between whitespace-nowrap border-b border-solid border-slate-200 dark:border-slate-800 px-4 py-3 bg-white/95 dark:bg-slate-900/95 backdrop-blur-lg safe-area-top">
                <div class="flex items-center gap-3">
                    <div class="size-8 flex items-center justify-center bg-primary rounded-lg text-white">
                        <span class="material-symbols-outlined text-xl">engineering</span>
                    </div>
                    <h2 class="text-slate-900 dark:text-white text-lg font-bold leading-tight tracking-tight">Mobile
                        ATEM
                    </h2>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="loadData()"
                        class="flex items-center justify-center rounded-full size-10 bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 hover:text-primary transition-colors active:scale-95">
                        <span class="material-symbols-outlined">refresh</span>
                    </button>
                    <!-- Profile button removed since login is disabled -->
                </div>
            </header>

            <!-- Metrics Carousel -->
            <div class="pt-5 pb-4">
                <div class="flex overflow-x-auto no-scrollbar px-4 gap-3 items-stretch">
                    <!-- On Process -->
                    <div class="flex flex-col gap-3 p-4 rounded-xl min-w-[140px] flex-1 bg-primary text-white shadow-lg shadow-primary/20"
                        onclick="setFilter('On Process')">
                        <div class="flex justify-between items-start">
                            <span class="material-symbols-outlined opacity-80">engineering</span>
                        </div>
                        <div>
                            <p class="text-2xl font-bold leading-none" id="metricProcess">0</p>
                            <p class="text-white/80 text-xs font-medium uppercase tracking-wider mt-1">
                                On Process</p>
                        </div>
                    </div>
                    <!-- Done -->
                    <div class="flex flex-col gap-3 p-4 rounded-xl min-w-[140px] flex-1 bg-white dark:bg-slate-800 border border-slate-100 dark:border-slate-700 shadow-sm cursor-pointer hover:border-green-200 transition-colors active:scale-[0.98]"
                        onclick="setFilter('Done')">
                        <div class="flex justify-between items-start text-green-500">
                            <span class="material-symbols-outlined">check_circle</span>
                        </div>
                        <div>
                            <p class="text-slate-900 dark:text-white text-2xl font-bold leading-none" id="metricDone">0
                            </p>
                            <p
                                class="text-slate-500 dark:text-slate-400 text-xs font-medium uppercase tracking-wider mt-1">
                                Selesai</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Search Section -->
            <div class="px-4 pb-4">
                <div class="relative group">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <span
                            class="material-symbols-outlined text-slate-400 text-[20px] group-focus-within:text-primary transition-colors">search</span>
                    </div>
                    <input type="text" id="searchInput"
                        class="block w-full pl-10 pr-3 py-2.5 bg-slate-50 dark:bg-slate-800 border-none rounded-xl text-slate-900 dark:text-white placeholder-slate-400 focus:ring-2 focus:ring-primary/20 text-sm shadow-inner transition-all"
                        placeholder="Cari alat, kode, atau pelapor...">
                </div>
            </div>

            <!-- Section Header -->
            <div class="flex items-center justify-between px-4 pb-3">
                <h2 class="text-slate-900 dark:text-white text-xl font-bold leading-tight tracking-tight">Daftar Laporan
                </h2>
                <button onclick="setFilter('')"
                    class="text-primary text-sm font-semibold hover:underline active:scale-95">Lihat
                    Semua</button>
            </div>

            <!-- Reports List -->
            <div class="flex flex-col gap-4 px-4" id="cardsContainer">
                <!-- Content will be loaded here -->
                <div class="flex flex-col items-center justify-center py-10 opacity-50">
                    <span class="material-symbols-outlined text-4xl mb-2">sync</span>
                    <p>Memuat data...</p>
                </div>
            </div>

        </div>
    </div>

    <!-- Bottom Navigation Bar - Fixed - HIDDEN -->
    <nav
        class="fixed bottom-0 left-0 right-0 w-full bg-white/95 dark:bg-slate-900/95 backdrop-blur-lg border-t border-slate-200 dark:border-slate-800 z-50 shadow-[0_-4px_12px_rgba(0,0,0,0.08)] bottom-nav-safe hidden">
        <div class="flex justify-around items-center h-20 px-2">
            <a class="flex flex-col items-center justify-center flex-1 text-primary active:scale-90 transition-transform py-2"
                href="#">
                <span class="material-symbols-outlined text-[28px] mb-1"
                    style="font-variation-settings: 'FILL' 1;">dashboard</span>
                <span class="text-[11px] font-bold">Dashboard</span>
            </a>
            <a class="flex flex-col items-center justify-center flex-1 text-slate-400 dark:text-slate-500 hover:text-slate-600 transition-colors active:scale-90 py-2"
                href="#" onclick="event.preventDefault(); setFilter('On Process')">
                <span class="material-symbols-outlined text-[28px] mb-1">pending_actions</span>
                <span class="text-[11px] font-medium">Tugas</span>
            </a>
            <a class="flex flex-col items-center justify-center flex-1 text-slate-400 dark:text-slate-500 hover:text-slate-600 transition-colors active:scale-90 py-2"
                href="#" onclick="event.preventDefault(); setFilter('Done')">
                <span class="material-symbols-outlined text-[28px] mb-1">history</span>
                <span class="text-[11px] font-medium">Riwayat</span>
            </a>
            <a class="flex flex-col items-center justify-center flex-1 text-slate-400 dark:text-slate-500 hover:text-red-500 transition-colors active:scale-90 py-2"
                href="#" onclick="event.preventDefault(); confirmLogout()">
                <span class="material-symbols-outlined text-[28px] mb-1">logout</span>
                <span class="text-[11px] font-medium">Logout</span>
            </a>
        </div>
    </nav>

    <!-- Loading Overlay -->
    <div id="loadingOverlay"
        class="fixed inset-0 z-[60] bg-white/90 dark:bg-gray-900/90 flex flex-col items-center justify-center gap-4 transition-opacity duration-300 hidden opacity-0">
        <div class="relative flex items-center justify-center">
            <div class="w-12 h-12 border-4 border-slate-200 dark:border-slate-700 rounded-full"></div>
            <div
                class="w-12 h-12 border-4 border-primary border-t-transparent rounded-full animate-spin absolute top-0 left-0">
            </div>
        </div>
        <p class="text-sm font-semibold text-slate-600 dark:text-slate-300 animate-pulse">Sedang Memuat Data...</p>
    </div>

    <!-- JS Dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        let allData = [];
        let currentFilter = 'On Process'; // Default filter set to On Process

        // Check Auth on Load
        document.addEventListener('DOMContentLoaded', function () {
            checkAuth();

            // Search Listener
            document.getElementById('searchInput').addEventListener('input', function () {
                renderCards(filterDataList(allData));
            });

            // Prevent default pull-to-refresh on some browsers
            document.body.addEventListener('touchmove', function (e) {
                if (e.scale !== 1) { e.preventDefault(); }
            }, { passive: false });
        });

        function checkAuth() {
            // LOGIN DISABLED - Always show content
            const overlay = document.getElementById('loginOverlay');
            overlay.classList.add('hidden');
            overlay.classList.add('opacity-0');
            overlay.classList.add('pointer-events-none');

            // Load Data directly
            loadData();

            /* ORIGINAL LOGIN CODE - COMMENTED OUT
            const userStr = sessionStorage.getItem('user');
            const overlay = document.getElementById('loginOverlay');

            if (!userStr) {
                // Not logged in: Show Overlay
                overlay.classList.remove('hidden');
                // Use small timeout to allow display:flex to apply before opacity transition
                setTimeout(() => {
                    overlay.classList.remove('opacity-0');
                    overlay.classList.remove('pointer-events-none');
                }, 10);
                return;
            }

            try {
                // Auth Success: Hide Overlay
                overlay.classList.add('opacity-0');
                overlay.classList.add('pointer-events-none');
                setTimeout(() => { overlay.classList.add('hidden'); }, 500);

                // Load Data
                loadData();
            } catch (e) {
                sessionStorage.removeItem('user');
                window.location.reload();
            }
            */
        }

        function handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            showLoading();

            google.script.run
                .withSuccessHandler(function (response) {
                    hideLoading();
                    if (response.success) {
                        // Save session
                        const userStore = {
                            username: response.username,
                            fullName: response.fullName,
                            role: response.role
                        };
                        sessionStorage.setItem('user', JSON.stringify(userStore));

                        // Refresh/Re-check
                        checkAuth();

                        Swal.fire({
                            icon: 'success',
                            title: 'Login Berhasil',
                            text: 'Selamat datang kembali!',
                            timer: 1500,
                            showConfirmButton: false,
                            customClass: { popup: 'rounded-xl' }
                        });
                    } else {
                        Swal.fire({
                            title: 'Login Gagal',
                            text: response.message,
                            icon: 'error',
                            confirmButtonColor: '#137fec',
                            customClass: { popup: 'rounded-xl' }
                        });
                    }
                })
                .withFailureHandler(function (err) {
                    hideLoading();
                    Swal.fire('System Error', err.message, 'error');
                })
                .authenticateUser(username, password);
        }

        function showLoading() {
            const overlay = document.getElementById('loadingOverlay');
            overlay.classList.remove('hidden');
            setTimeout(() => { overlay.classList.remove('opacity-0'); }, 10);
        }

        function hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            overlay.classList.add('opacity-0');
            setTimeout(() => { overlay.classList.add('hidden'); }, 300);
        }

        function confirmLogout() {
            Swal.fire({
                title: 'Logout?',
                text: "Anda akan keluar dari sesi ini.",
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#137fec',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Ya, Logout',
                cancelButtonText: 'Batal',
                customClass: { popup: 'rounded-xl' }
            }).then((result) => {
                if (result.isConfirmed) {
                    logout();
                }
            });
        }

        function logout() {
            sessionStorage.removeItem('user');
            window.location.reload(); // Reload triggers checkAuth -> shows login overlay
        }

        function loadData() {
            showLoading();
            google.script.run
                .withSuccessHandler(function (data) {
                    hideLoading();
                    // FILTER: Only On Process and Done
                    allData = data.filter(item => item.status === 'On Process' || item.status === 'Done').reverse();
                    updateMetrics();
                    // Apply default filter (On Process)
                    renderCards(filterDataList(allData));
                })
                .withFailureHandler(function (error) {
                    hideLoading();
                    Swal.fire({
                        title: 'Error',
                        text: 'Gagal memuat data: ' + error.message,
                        icon: 'error',
                        confirmButtonColor: '#137fec'
                    });
                })
                .getLaporanData();
        }

        function updateMetrics() {
            const onProcess = allData.filter(i => i.status === 'On Process').length;
            const done = allData.filter(i => i.status === 'Done').length;

            document.getElementById('metricProcess').textContent = onProcess;
            document.getElementById('metricDone').textContent = done;
        }

        function setFilter(status) {
            currentFilter = status;
            renderCards(filterDataList(allData));

            // Scroll to top smoothly
            document.querySelector('.main-scroll-container').scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }

        function filterDataList(data) {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            return data.filter(item => {
                const matchesSearch =
                    (item.laporanId && item.laporanId.toLowerCase().includes(searchTerm)) ||
                    (item.alat && item.alat.toLowerCase().includes(searchTerm)) ||
                    (item.pelapor && item.pelapor.toLowerCase().includes(searchTerm)) ||
                    (item.keluhan && item.keluhan.toLowerCase().includes(searchTerm));

                const matchesStatus = currentFilter === '' || item.status === currentFilter;

                return matchesSearch && matchesStatus;
            });
        }

        function renderCards(data) {
            const container = document.getElementById('cardsContainer');

            if (data.length === 0) {
                container.innerHTML = `
                    <div class="flex flex-col items-center justify-center py-12 text-center text-slate-400">
                        <div class="bg-slate-50 dark:bg-slate-800 p-6 rounded-full mb-4">
                            <span class="material-symbols-outlined text-4xl">search_off</span>
                        </div>
                        <h3 class="text-lg font-semibold text-slate-600 dark:text-slate-300">Tidak ada data</h3>
                        <p class="text-sm">Tidak ditemukan laporan sesuai filter.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = data.map(item => {
                // Status Configuration
                const isDone = item.status === 'Done';
                const statusColor = isDone
                    ? 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400'
                    : 'bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-400';

                // Image handling
                const bgImage = item.gambar
                    ? `url('${item.gambar}')`
                    : 'none';

                const hasImageClass = item.gambar ? 'bg-cover bg-center' : 'bg-slate-100 dark:bg-slate-800 flex items-center justify-center';
                const imageContent = item.gambar ? '' : '<span class="material-symbols-outlined text-slate-300">image</span>';

                // Escaping data
                const escapeStr = (str) => (str || '').replace(/'/g, "\\'").replace(/"/g, "&quot;").replace(/\n/g, "\\n");

                const identifikasi = escapeStr(item.identifikasi);
                const tindakan = escapeStr(item.tindakan);
                const rekomendasi = escapeStr(item.rekomendasi);
                const catatan = escapeStr(item.catatan);

                return `
                <div class="flex flex-col gap-4 rounded-xl bg-white dark:bg-slate-800 p-4 shadow-[0_2px_8px_rgba(0,0,0,0.06)] border border-slate-50 dark:border-slate-700 hover:shadow-md transition-shadow">
                    <div class="flex items-start justify-between gap-4">
                        <div class="flex flex-col gap-1.5 flex-1 min-w-0">
                            <div class="flex items-center gap-2">
                                <span class="px-2 py-0.5 rounded ${statusColor} text-[10px] font-bold uppercase tracking-wider">
                                    ${item.status}
                                </span>
                                <p class="text-slate-400 dark:text-slate-500 text-xs font-medium truncate">${item.tanggal || '-'}</p>
                            </div>
                            <h3 class="text-slate-900 dark:text-white text-base font-bold leading-tight truncate pr-2">${item.alat}</h3>
                            <p class="text-slate-500 dark:text-slate-400 text-xs font-mono mb-1">${item.kode || '#'}</p>
                            <p class="text-slate-600 dark:text-slate-300 text-sm line-clamp-2">${item.keluhan}</p>
                        </div>
                        
                        <!-- Image Viewer -->
                        <div class="size-20 rounded-lg flex-shrink-0 border border-slate-100 dark:border-slate-700 overflow-hidden cursor-pointer active:scale-95 transition-transform ${hasImageClass}"
                             onclick="${item.gambar ? `viewImage('${item.gambar}')` : ''}"
                             style="background-image: ${bgImage};">
                             ${imageContent}
                        </div>
                    </div>
                    
                    <!-- Footer Info -->
                     <div class="grid grid-cols-2 gap-2 text-xs">
                        <div class="bg-slate-50 dark:bg-slate-800/50 p-2 rounded flex flex-col">
                            <span class="text-[10px] uppercase text-slate-400 font-bold">Ruangan</span>
                            <span class="font-medium truncate">${item.ruangan || '-'}</span>
                        </div>
                        <div class="bg-slate-50 dark:bg-slate-800/50 p-2 rounded flex flex-col">
                            <span class="text-[10px] uppercase text-slate-400 font-bold">Pelapor</span>
                            <span class="font-medium truncate">${item.pelapor || '-'}</span>
                        </div>
                    </div>

                    ${!isDone ? `
                    <div class="pt-2 border-t border-slate-50 dark:border-slate-700">
                        <button onclick="openUpdateModal('${item.id}', '${item.laporanId}', '${identifikasi}', '${tindakan}', '${rekomendasi}', '${catatan}')"
                            class="flex w-full items-center justify-center rounded-lg h-10 px-4 bg-primary text-white gap-2 text-sm font-semibold shadow-sm shadow-primary/30 active:scale-[0.98] transition-transform">
                            <span class="material-symbols-outlined text-lg">edit_note</span>
                            <span>Update Pengerjaan</span>
                        </button>
                    </div>
                    ` : ''}
                </div>
                `;
            }).join('');
        }

        function viewImage(url) {
            Swal.fire({
                imageUrl: url,
                imageAlt: 'Foto Kerusakan',
                width: '90%',
                background: '#fff',
                showConfirmButton: false,
                showCloseButton: true,
                customClass: { popup: 'rounded-xl overflow-hidden' }
            });
        }

        // Modal Logic
        function openUpdateModal(id, laporanId, identifikasi, tindakan, rekomendasi, catatan) {
            Swal.fire({
                title: `<span class="text-lg font-bold text-slate-900">Update ${laporanId}</span>`,
                html: `
                    <div class="flex flex-col gap-3 text-left max-h-[60vh] overflow-y-auto px-1">
                        <div>
                            <label class="block text-xs font-semibold text-slate-500 uppercase tracking-wider mb-1">Identifikasi</label>
                            <textarea id="swalIdentifikasi" class="w-full p-2.5 rounded-lg border border-slate-300 focus:ring-2 focus:ring-primary/20 focus:border-primary text-sm min-h-[70px] bg-slate-50" placeholder="Hasil identifikasi...">${identifikasi}</textarea>
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-slate-500 uppercase tracking-wider mb-1">Tindakan</label>
                            <textarea id="swalTindakan" class="w-full p-2.5 rounded-lg border border-slate-300 focus:ring-2 focus:ring-primary/20 focus:border-primary text-sm min-h-[70px] bg-slate-50" placeholder="Tindakan perbaikan...">${tindakan}</textarea>
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-slate-500 uppercase tracking-wider mb-1">Rekomendasi / Catatan</label>
                            <textarea id="swalRekomendasi" class="w-full p-2.5 rounded-lg border border-slate-300 focus:ring-2 focus:ring-primary/20 focus:border-primary text-sm min-h-[60px] bg-slate-50" placeholder="Rekomendasi kedepan...">${rekomendasi}</textarea>
                        </div>
                         <div class="hidden">
                            <textarea id="swalCatatan">${catatan}</textarea>
                        </div>
                        
                        <div class="mt-2 bg-green-50 border border-green-100 rounded-lg p-3 flex items-start gap-3">
                            <input type="checkbox" id="swalMarkAsDone" class="mt-1 w-4 h-4 rounded border-slate-300 text-green-600 focus:ring-green-500">
                            <label for="swalMarkAsDone" class="text-sm">
                                <span class="block font-bold text-green-800">Tandai Selesai (Done)</span>
                                <span class="block text-xs text-green-700/80">Centang jika perbaikan telah tuntas dilaksanakan.</span>
                            </label>
                        </div>
                    </div>
                `,
                showCancelButton: true,
                confirmButtonText: 'Simpan',
                cancelButtonText: 'Batal',
                confirmButtonColor: '#137fec',
                cancelButtonColor: '#94a3b8',
                width: '95%',
                padding: '1.25rem',
                customClass: {
                    popup: 'rounded-xl',
                    confirmButton: 'rounded-lg font-semibold px-6',
                    cancelButton: 'rounded-lg font-semibold px-6'
                },
                preConfirm: () => {
                    const identifikasi = document.getElementById('swalIdentifikasi').value;
                    const tindakan = document.getElementById('swalTindakan').value;
                    const rekomendasi = document.getElementById('swalRekomendasi').value;
                    const catatan = document.getElementById('swalCatatan').value;
                    const markAsDone = document.getElementById('swalMarkAsDone').checked;

                    if (markAsDone && !tindakan) {
                        Swal.showValidationMessage('Isi tindakan jika ingin menyelesaikan laporan!');
                        return false;
                    }

                    return { identifikasi, tindakan, rekomendasi, catatan, markAsDone };
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    submitUpdate(id, result.value);
                }
            });
        }

        function submitUpdate(id, details) {
            showLoading();
            google.script.run
                .withSuccessHandler(function (response) {
                    hideLoading();
                    if (response.success) {
                        Swal.fire({
                            title: 'Berhasil',
                            text: 'Data berhasil diperbarui',
                            icon: 'success',
                            timer: 1500,
                            showConfirmButton: false,
                            customClass: { popup: 'rounded-xl' }
                        });
                        loadData();
                    } else {
                        Swal.fire('Gagal!', response.message, 'error');
                    }
                })
                .withFailureHandler(function (error) {
                    hideLoading();
                    Swal.fire('Error', error.message, 'error');
                })
                .updateLaporanDetails(id, details);
        }
    </script>
</body>

</html>